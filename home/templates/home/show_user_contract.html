{% extends 'home/base.html'%}

{% load staticfiles %}
{% block title %}
Pay Membership
{% endblock %}

{% block body %}


<div class="row text-center">
	<div class="col-12">
		User Agreement
		<div id="embed" class="embed-responsive embed-responsive-16by9">
		  <!-- <embed id="pdf_display" class="embed-responsive-item"> -->
		  	<iframe src="/get_image/contracts/algos.pdf/"></iframe>
		</div>
	</div>
	<div class="col-12" name="signatureImg">
		<iframe src="" id="sigImg"></iframe>
	</div>
	<div class="col-12" name="signaturepad">
		<canvas style="border-bottom: 3px solid black;"></canvas>
    </div>
    <div class="col-12" name="signaturepad">
        <button type="button" class="button" data-action="clear">Clear</button>
        <button type="button" class="button save" data-action="save-png">Save as PNG</button>
    </div>
	
</div>

<div class="row" id="success"></div>


<script  src="{% static 'home/js/ajax_helper.js' %}"></script>


<script src="{% static 'home/js/signature_pad.js' %}" type='text/javascript'></script>


<script>
let userpk = {{userpk}};
let contractpk = {{contractpk}};
let signContract = {{signContract}};

console.log(`userpk: ${userpk}`);




var canvas = document.querySelector("canvas");
canvas.height = 150;
canvas.width = (window.innerWidth * .6);


window.onresize = () => {
	let canvas = document.querySelector("canvas")
	canvas.width = (window.innerWidth * .6);
};




function displaySignature(userpk, contractpk){
	// Hide Signature pad buttons
	document.querySelectorAll("[name='signaturepad']").forEach((el)=>{
		el.hidden = true;
	});
	
	
	getData(`/api/user_contract/user/${userpk}/document/${contractpk}/`)
	.then((data)=>{
		console.log(data);
		// /media/contractSignatures/ekildog_useragreement_0aJV9jO.png
		let urlSplit = data[0].signature.split("/");
		
		
		getData(`/get_image/${urlSplit[1]}/${urlSplit[2]}/`)
		.then((httpImg)=>{
			console.log(data);
			document.querySelector("#sigImg").src = httpImg;
		});

	});
}



function createSignaturePad(){
	var signaturePad = new SignaturePad(canvas);

	signaturePad.on();

	document.querySelector("[data-action='clear']").addEventListener("click", (ev) => {
		signaturePad.clear();
	});

	document.querySelector("[data-action='save-png']").addEventListener("click", (ev) => {
		if(signaturePad.isEmpty()){
			alert("Need signature");
			ev.preventDefault();
		}else{
			console.log();
			let png = signaturePad.toDataURL();
			let signedContract = {
				"signature": png,
				"userpk" : userpk,
				"contractpk" : contractpk,
			};

			postData("/api/user_contract/", signedContract).then((data) => {
				console.log(data);
				document.querySelector('#embed').style.display = "none";
				document.querySelectorAll('[name="signaturepad"]').forEach( (el) =>{
					el.style.display = "none";

				} );

				document.querySelector('#success').innerHTML = `
					<div class="col-12 text-center">
						${data}
					</div>`;
			});
		}
	});	
}

if(signContract == 0){
	displaySignature(userpk, contractpk);
}else{
	createSignaturePad();
}

</script>

{% endblock %}